<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ÙŠÙˆ Sweet & Salt</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; text-align: center; }
        .menu-container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #d35400; }
        .item-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        button { background-color: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        button:active { transform: scale(0.98); }
        #lockScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        #statusTag { color: #7f8c8d; font-size: 14px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="lockScreen">
    <h2 style="color: #e74c3c;">Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ø´ØºÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ”´</h2>
    <p>ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø§Ø¯Ù„ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰.</p>
</div>

<div class="menu-container" id="mainContent">
    <h1>Sweet & Salt ğŸ”</h1>
    <div id="statusTag">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø§ÙˆÙ„Ø©...</div>

    <div class="item-card">
        <span>Ø¨ÙŠØªØ²Ø§ Ù…Ø§Ø±ØºØ±ÙŠØªØ§ (1200 Ø¯Ø¬)</span>
        <button onclick="addToCart('Ø¨ÙŠØªØ²Ø§ Ù…Ø§Ø±ØºØ±ÙŠØªØ§', 1200)">Ø¥Ø¶Ø§ÙØ© +</button>
    </div>

    <div class="item-card">
        <span>Ø¨Ø±Ø¬Ø± Ø¯Ø¬Ø§Ø¬ (850 Ø¯Ø¬)</span>
        <button onclick="addToCart('Ø¨Ø±Ø¬Ø± Ø¯Ø¬Ø§Ø¬', 850)">Ø¥Ø¶Ø§ÙØ© +</button>
    </div>

    <hr>
    <button style="background: #e67e22; width: 100%; padding: 15px;" onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ ğŸ“¤</button>
</div>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSy...", 
        projectId: "restaurant-e323a",
        appId: "..."
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
    const TABLE_ID = "1"; // Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯)
    let mySid = localStorage.getItem('mySid') || Math.random().toString(36).substr(2, 9);
    localStorage.setItem('mySid', mySid);
    
    let isSessionActive = true; 
    let cart = [];

    // 3. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹
    function listenToTable() {
        const tableRef = db.collection("tables_status").doc(TABLE_ID);

        tableRef.onSnapshot((doc) => {
            if (!isSessionActive) return;

            if (doc.exists) {
                const data = doc.data();

                // Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø¥Ø°Ø§ Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ù†ÙŠÙˆ Ø¥Ø´Ø§Ø±Ø© "released" Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                if (data.currentUser === "released" || (data.isBusy === false && data.currentUser === "")) {
                    isSessionActive = false;
                    alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…!");
                    document.getElementById('mainContent').innerHTML = "<h2>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…! Ù†Ø±Ø¬Ùˆ Ø£Ù† ØªÙƒÙˆÙ†ÙˆØ§ Ù‚Ø¯ Ø§Ø³ØªÙ…ØªØ¹ØªÙ… Ø¨ÙˆØ¬Ø¨ØªÙƒÙ…. ğŸ˜Š</h2>";
                    return;
                }

                // Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ø²Ø¨ÙˆÙ† Ø¢Ø®Ø±
                if (data.isBusy && data.currentUser !== mySid) {
                    document.getElementById('lockScreen').style.display = 'flex';
                } else {
                    document.getElementById('lockScreen').style.display = 'none';
                    document.getElementById('statusTag').innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø·Ø§ÙˆÙ„Ø© " + TABLE_ID + " âœ…";
                    
                    // Ø­Ø¬Ø² Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                    if (!data.isBusy) {
                        tableRef.set({ isBusy: true, currentUser: mySid }, { merge: true });
                    }
                }
            }
        });
    }

    // 4. Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
    function addToCart(name, price) {
        cart.push({ name: name, price: price });
        alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© " + name);
    }

    // 5. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© caisse Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ ÙŠØ·Ù„Ø¨Ù‡Ø§ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    function sendOrder() {
        if (cart.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");

        const total = cart.reduce((sum, item) => sum + item.price, 0);

        db.collection("caisse").add({
            hn: parseInt(TABLE_ID), // Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (Ø±Ù‚Ù…ÙŠ ÙƒÙ…Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
            plat: cart.map(item => ({ pla1: item.name, pr1: item.price })), // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø±Ø£Ù‡ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
            total: total,
            status: "Ø¬Ø¯ÙŠØ¯",
            time: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨! Ø³ÙŠØªÙ… ØªØ­Ø¶ÙŠØ±Ù‡ Ø§Ù„Ø¢Ù†.");
            cart = []; 
        });
    }

    window.onload = listenToTable;
</script>

</body>
</html>
